
@{
	Layout = null;
}

<!DOCTYPE html>

<html>
<head>
	<meta name="viewport" content="width=device-width" />
	<title>Peta</title>
	<link href="~/lib/leaflet/dist/leaflet.css" rel="stylesheet" />
	<link href="~/lib/font-awesome/css/all.min.css" rel="stylesheet" />
	<link href="~/lib/font-awesome/css/v4-shims.min.css" rel="stylesheet" />
	@*<link href="~/lib/font-awesome/css/fontawesome.min.css" rel="stylesheet" />*@
	<link href="~/lib/Leaflet-label/leaflet.label.css" rel="stylesheet" />
	<link href="~/lib/Leaflet-EasyButton/easy-button.css" rel="stylesheet" />
	<link href="~/lib/Leaflet-contextmenu/leaflet.contextmenu.min.css" rel="stylesheet" />
	<link href="~/css/site.css" rel="stylesheet" />

	<script src="~/lib/jquery/dist/jquery.min.js"></script>
	<script src="~/lib/font-awesome/js/fontawesome.min.js"></script>
	<script src="~/lib/leaflet/dist/leaflet-src.js"></script>
	<script src="~/lib/Leaflet-label/leaflet.label-src.js"></script>
	<script src="~/js/spin.min.js"></script>
	<script src="~/lib/Leaflet-Spin/leaflet.spin.js"></script>
	<script src="~/lib/Leaflet-EasyButton/easy-button.js"></script>
	<script src="~/lib/Leaflet-contextmenu/leaflet.contextmenu.min.js"></script>
	<script src="~/js/coloring.js"></script>
	<script async defer
					src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA5ka-0TfDOwbvnrxJpr2Q_7saN9FhxLhQ">
	</script>
	<!--AIzaSyAZaUgvw3YA1liuNWA7GpgIYJZy-P5jUAM">-->
	<script src="~/lib/leaflet/dist/Leaflet.GoogleMutant.js"></script>
</head>
<body>
	<script src="~/Home/Root"></script>
	<div id="map"></div>
	<div id="legends">
		<p><b>Legends</b></p>
		<table style="border:0px"><tr><td class="color bebas">&nbsp;</td><td class="legend">Bebas</td></tr></table>
		<table style="border:0px"><tr><td class="color belum-bebas-shm">&nbsp;</td><td class="legend">Belum bebas, SHM</td></tr></table>
		<table style="border:0px"><tr><td class="color hibah-sudah-pbt">&nbsp;</td><td class="legend">Belum bebas, hibah, sudah PBT</td></tr></table>
		<table style="border:0px"><tr><td class="color hibah-belum-pbt">&nbsp;</td><td class="legend">Belum bebas, hibah, belum PBT</td></tr></table>
		<table style="border:0px"><tr><td class="color kampung">&nbsp;</td><td class="legend">Kampung</td></tr></table>
		<table style="border:0px"><tr><td class="color bengkok-desa">&nbsp;</td><td class="legend">Bengkok desa</td></tr></table>
	</div>
	<div id="panel">
		<p><b>Atur Tampilan Peta</b></p>
		<p>Pilih Project<br />
										<select id="selpro" style="width:calc(100% - 14px);">
											<option value="PROJECT002">PIK 2 Extension</option>
											<option value="PROJECT003">PIK 3</option>
										</select></p>
		<p>
			Pilih Desa<br />
			<select id="selvil" style="width:calc(100% - 14px);">
			</select>
		</p>
	</div>
	@*<div class="grid-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
			<div id="map"></div>
			<div class="legends">
				<div id="map" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
			</div>
			<div class="panel"></div>
		</div>*@

	<script type="text/javascript">


		var mapopts = {
			preferCanvas: true,
			tap: true,
			touchZoom: true
			//      zoomSnap: 0.1
			//contextmenu: true,
			//contextmenuWidth: 140,
			//contextmenuItems: [{
			//	text: 'Normal Map',
			//	callback: showNormal
			//}, {
			//	text: 'Process Status',
			//	callback: showStatus
			//}, {
			//	text: 'Payment Status',
			//	callback: showPayment
			//}]
		};
		//pk.eyJ1Ijoiam9zZXJwb25nIiwiYSI6ImNqNWRjdTdnczBvcHIzM3I2em9oaHZpbmMifQ.cU78B8KCk2JcVp4WckrDDA

		var map = L.map('map', mapopts).setView([-6.027965, 106.624451], 15.5 );

		function showNormal() { }
		function showStatus() { }
		function showPayment() { }
		//L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoiam9zZXJwb25nIiwiYSI6ImNqNWRjdTdnczBvcHIzM3I2em9oaHZpbmMifQ.cU78B8KCk2JcVp4WckrDDA', {
		//	maxZoom: 18,
		//	attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
		//		'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
		//		'Imagery © <a href="http://mapbox.com">Mapbox</a>',
		//	id: 'mapbox.streets'
		//}).addTo(map);

		var roadMutant = L.gridLayer.googleMutant({
			maxZoom: 24,
			type: 'roadmap'
		})

		var satMutant = L.gridLayer.googleMutant({
			maxZoom: 24,
			type: 'satellite'
		});

		var terrainMutant = L.gridLayer.googleMutant({
			maxZoom: 24,
			type: 'terrain'
		});

		var hybridMutant = L.gridLayer.googleMutant({
			maxZoom: 24,
			type: 'hybrid'
		}).addTo(map);

		L.control.layers({
			Gabungan: hybridMutant,
			Satelit: satMutant,
			Jalanan: roadMutant,
			Informasi: terrainMutant
		}, {}, {
			collapsed: false
		}).addTo(map);

		//var sayHello = alert("Hello");
		//var sayGoodbye = alert("Good bye");

		//L.control.layers({ Hello: sayHello, Goodbye: sayGoodbye }, {}, { collapsed: false }).addTo(map);

		L.control.scale().addTo(map);
		//L.easyButton({
		//	states: [{
		//		stateName: 'normal',
		//		icon: 'fa fa-refresh fa-lg', title: 'Refresh', onClick: function () {
		//			var hdata = (myhistory.length == 0) ? { t: 'p', ip: null, isk: null, fc: '80ffffff', sc: '80000080' } : myhistory.pop();
		//			ShowMap(hdata);
		//		}
		//	}]
		//}).addTo(map);
		//L.easyButton({
		//	states: [{
		//		stateName: 'normal',
		//		icon: 'fa fa-level-up fa-lg', title: 'Level Up', onClick: function () {
		//			myhistory.pop();
		//			var hdata = (myhistory.length == 0) ? { t: 'p', ip: null, isk: null, fc: '80ffffff', sc: '80000080' } : myhistory.pop();
		//			ShowMap(hdata);
		//		}
		//	}]
		//}).addTo(map);
		//L.easyButton({
		//	states: [{
		//		stateName: 'normal',
		//		icon: 'fa fa-home  fa-lg', title: 'Home', onClick: function () {
		//			var hdata = { t: 'p', ip: null, isk: null, fc: '80ffffff', sc: '80000080' };
		//			myhistory.length = 0;
		//			ShowMap(hdata);
		//		}
		//	}]
		//}).addTo(map);

		//map.doubleClickZoom.disable();

		var labels = new Array();
		var layers = new Array();
		var myhistory = new Array();

		function onEachFeature(feature, layer) {

			var latlngs = feature.geometry.coordinates;
			var style = Style(feature);
			style.interactive = true;
			var polygon = L.polygon(latlngs, style).addTo(map);

			var content = '<table border="0" cellpadding="1" cellspacing="1">';
			if (feature.properties) {
				for (var key in feature.properties) {
					if (key.substr(0, 1) != '-' || key.substr(0, 4) == '-idx')
						continue;
					content += '<tr><td><b>' + key.substring(1) + '</b></td><td><b>:</b> ' + feature.properties[key] + '</td></tr>';
				}
			}
			content += '</table>';

			if (feature.properties && feature.properties.popupContent)
				content += feature.properties.popupContent;

			layer.properties = feature.properties;

			(function (layer, properties) {
      // Create a mouseover event
				layer.on("mouseover", e => {
					layer.setStyle({ weight: 6 });
				});
      // Create a mouseout event that undoes the mouseover changes
      layer.on("mouseout", function (e) {
        // Start by reverting the style back
				layer.setStyle({weight:2}); 
        // And then destroying the popup
      });
      // Close the "anonymous" wrapper function, and call it while passing
      // in the variables necessary to make the events work the way we want.
			})(polygon, feature.properties);


			var label = L.marker({ lat: feature.properties["-idx-lat"], lng: feature.properties["-idx-lon"] }, {
				icon: L.divIcon({
					className: 'label',
					html: "<font style=\"font-family:\"Helvetica Neue\", Arial, Helvetica, sans-serif;font-size:9pt;color:black;background-color:rgba(255,255,255,0.2);white-space:nowrap;\">&nbsp;<b>" + feature.properties["label"] + "</b>&nbsp;</font/>"
					, iconSize: [80, 24]
				})
			});
			label.addTo(map);
			labels.push(label);
			layers.push(layer);

			var dblclickfunction = function (e) {
				// do something here like display a popup
				var reload = false;
				switch (currType) {
					case 'p':
						currP = layer.properties['-idx'];
						currType = 's';
						reload = true;
						; break;
					case 's':
						currS = layer.properties['-idx'];
						currType = 'g';
						reload = true;
						; break;
				}
			};

			var cmenufunction = function (e) {
				// do something here like display a popup
				e.originalEvent.preventDefault();
				e.target.bindPopup(content).openPopup();
				return false;
			}

			var clickfunction = function (e) {
				var reload = false;
				switch (currType) {
					case 'p':
						currP = layer.properties['-idx'];
						currType = 's';
						reload = true;
						; break;
					case 's':
						currS = layer.properties['-idx'];
						currType = 'g';
						reload = true;
						; break;
				}

				if (reload)
					window.setTimeout(ShowMap(), 100);
			};

			layer.on("click", clickfunction);
			label.on("click", clickfunction);
			layer.on("contextmenu", cmenufunction);
			label.on("contextmenu", cmenufunction);
			layer.on("dblclick", dblclickfunction);
			label.on("dblclick", dblclickfunction);

			//layer.bindPopup(content);
			//label.bindPopup(content);

			//layer.on("mouseover", e => {
			//	layer.setStyle({ weight: 6 });
			//});
			//layer.on("mouseout", e => {
			//	layer.setStyle({ weight: 2 });
			//});

			label.on("mouseover", e => {
				layer.setStyle({ weight: 6 });
			});
			label.on("mouseout", e => {
				layer.setStyle({ weight: 2 });
			});
		}

		var currType = 'p';
		var currP = null;
		var currS = null;

		function ShowMap(hdata) {
			map.spin(true);

			if (typeof hdata == 'undefined')
				hist = { t: currType, ip: currP, isk: currS, fc: '80ffffff', sc: '80000080' };
			else {
				hist = hdata;
				currType = hist.t;
				currP = hist.ip;
				currS = hist.isk;
			}
			// test
			hist = { t: 'g', ip: 'VILLAGE003003', isk: currS, fc: '80ffffff', sc: '80000080' };
			////
			myhistory.push(hist);
			//currType = 'g';
			$.ajax({ url: $myroot + 'api/map', method: 'GET', data: hist, dataType: "json" })
				//$.ajax({ url: $myroot + 'sample/features4.js', method: 'GET', dataType: "json" })
				.done(jdata => {
					//geojson = new L.geoJSON(jdata, { style: Style }).addTo(map);

					map.spin(false);
					try {
						for (var x in labels)
							labels[x].removeFrom(map);
						for (var x in layers)
							layers[x].removeFrom(map);
					}
					catch (e) { }

					geojson = L.geoJSON(jdata, { onEachFeature: onEachFeature }).addTo(map);

					if (currType == 'p')
						map.setView([jdata.center.y, jdata.center.x]);
					//$(jdata.features).each(function (key, data) {
					//	if (data.geometry.type == 'Polygon') {
					//		statuscd = data.properties["status"];
					//		if (typeof statuscd == 'undefined')
					//			statusc = "0";
					//		istatus = parseInt(statuscd);
					//		var attrib;
					//		try {
					//			attrib = statusattr[istatus];
					//		}
					//		catch (e) {
					//			attrib = statusattr[0];
					//		}
					//		geojson.initialize(data, {
					//			style: {
					//				weight: 20,
					//				color: statusattr.color,
					//				alpha: statusattr.alpha,
					//				fillColor: statusattr.fillColor,
					//				fillAlpha: statusattr.fillAlpha
					//			},
					//			onEachFeature: onEachFeature
					//		});
					//	}
					//	else
					//		geojson.addData(data);
					//});
				})
				.fail(function (xm, status, error) {
					map.spin(false);
					alert(status + "-" + error);
				});
		}

		var grid = L.gridLayer({
			attribution: 'Land Acquisition by Agung Sedayu Group',
			//      tileSize: L.point(150, 80),
			//      tileSize: tileSize
		});

		grid.createTile = function (coords) {
			var tile = L.DomUtil.create('div', 'tile-coords');
			tile.innerHTML = "";
			return tile;
		};

		map.addLayer(grid);

		ShowMap();

	</script>
</body>
</html>
